name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI/CD"]
    types:
      - completed

jobs:
  deploy:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest
    environment: VPS_SECRETS
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Mirror to secondary repo
        env:
          TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          GH_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verify API access
          echo "Checking API access..."
          curl -sS -o /tmp/target_repo_check.json -w "%{http_code}" \
            -H "Authorization: Bearer ${TARGET_REPO_TOKEN}" \
            https://api.github.com/repos/DentaFlow-Groupes/dentalFlow-DevSecOps \
            | tee /tmp/target_repo_status.txt
          STATUS_CODE="$(cat /tmp/target_repo_status.txt)"
          
          if [ "$STATUS_CODE" != "200" ]; then
            echo "Repo access check failed (HTTP $STATUS_CODE)."
            cat /tmp/target_repo_check.json || true
            exit 1
          fi
          
          echo "API access OK. Checking permissions..."
          cat /tmp/target_repo_check.json | grep -o '"permissions":{[^}]*}' || echo "No permissions info"
          
          # Configure git to use token
          git config --global url."https://oauth2:${TARGET_REPO_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          # Add remote and push
          git remote add mirror "https://github.com/DentaFlow-Groupes/dentalFlow-DevSecOps.git" || git remote set-url mirror "https://github.com/DentaFlow-Groupes/dentalFlow-DevSecOps.git"
          
          echo "Pushing to mirror repository..."
          git push --force mirror HEAD:main

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Create deploy directory
        run: |
          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "mkdir -p /home/${{ secrets.VPS_USER }}/dentaflow"

      - name: Upload project
        run: |
          rsync -az --delete \
            --exclude node_modules \
            --exclude dist \
            --exclude .git \
            --exclude .env \
            --exclude .DS_Store \
            ./ "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/${{ secrets.VPS_USER }}/dentaflow/"

      - name: Write .env on VPS
        env:
          SPRING_PROFILE: ${{ secrets.SPRING_PROFILE }}
          CORE_DB_NAME: ${{ secrets.CORE_DB_NAME }}
          CORE_DB_USER: ${{ secrets.CORE_DB_USER }}
          CORE_DB_PASSWORD: ${{ secrets.CORE_DB_PASSWORD }}
          CUSTOMER_DB_NAME: ${{ secrets.CUSTOMER_DB_NAME }}
          CUSTOMER_DB_USER: ${{ secrets.CUSTOMER_DB_USER }}
          CUSTOMER_DB_PASSWORD: ${{ secrets.CUSTOMER_DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          printf '%s\n' \
            "SPRING_PROFILE=$SPRING_PROFILE" \
            "CORE_DB_NAME=$CORE_DB_NAME" \
            "CORE_DB_USER=$CORE_DB_USER" \
            "CORE_DB_PASSWORD=$CORE_DB_PASSWORD" \
            "CUSTOMER_DB_NAME=$CUSTOMER_DB_NAME" \
            "CUSTOMER_DB_USER=$CUSTOMER_DB_USER" \
            "CUSTOMER_DB_PASSWORD=$CUSTOMER_DB_PASSWORD" \
            "JWT_SECRET=$JWT_SECRET" \
          | ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "cat > /home/${{ secrets.VPS_USER }}/dentaflow/.env && chmod 600 /home/${{ secrets.VPS_USER }}/dentaflow/.env"

      - name: Deploy
        run: |
          ssh "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "cd /home/${{ secrets.VPS_USER }}/dentaflow && docker compose up -d --build"
